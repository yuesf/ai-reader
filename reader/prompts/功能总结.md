## 报告服务接口与实现总结（最新）

### 一、概述
- **服务名称**: AI Reader 报告服务
- **说明**: 提供报告的统一查询、详情、创建、删除等接口；查询严格要求具备条件，避免全量扫描。
- **统一返回**: 所有接口统一使用 `ApiResponse` 包装。

```json
// ApiResponse<T>
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 二、基础信息
- **Base URL**: `/v1`
- **字符编码**: UTF-8
- **数据格式**: JSON
- **鉴权**: 无（按需扩展）

---

### 三、接口文档

#### 3.1 获取/搜索报告列表
- **说明**: 统一查询接口；必须带查询条件。若无 `keyword`，默认按最近 30 天的 `publishDate` 查询。
- **方法与地址**: `POST /v1/reports`

入参（ReportListRequest）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| page | number | 否 | 页码，默认 1 |
| pageSize | number | 否 | 每页数量，默认 10，最大 50 |
| keyword | string | 否 | 关键词（匹配标题/摘要/标签）|
| category | string | 否 | 分类（单值）|
| source | string | 否 | 来源（单值）|
| startDate | string(YYYY-MM-DD) | 否 | 开始日期（提供则覆盖默认近 30 天起始）|
| endDate | string(YYYY-MM-DD) | 否 | 结束日期（提供则覆盖默认近 30 天结束）|
| filters.category | array<string> | 否 | 分类多选 |
| filters.source | array<string> | 否 | 来源多选 |
| filters.dateRange.start | string(YYYY-MM-DD) | 否 | 高级开始日期 |
| filters.dateRange.end | string(YYYY-MM-DD) | 否 | 高级结束日期 |
| sortBy | string | 否 | 排序字段：publishDate/updateDate/title/downloadCount/viewCount/price/pages/fileSize（默认 publishDate）|
| sortOrder | string | 否 | 排序方向：asc/desc（默认 desc）|

出参（ReportListResponse）

| 字段 | 类型 | 说明 |
|---|---|---|
| total | number | 总记录数 |
| page | number | 当前页 |
| pageSize | number | 每页数量 |
| list | array<Report> | 报告列表 |

Report 对象

| 字段 | 类型 | 说明 |
|---|---|---|
| id | string | 报告ID |
| title | string | 标题 |
| summary | string | 摘要 |
| source | string | 来源 |
| category | string | 分类 |
| pages | number | 页数 |
| fileSize | number | 文件大小（KB）|
| publishDate | string | 发布日期（YYYY-MM-DD）|
| updateDate | string | 更新日期（YYYY-MM-DD）|
| thumbnail | string | 缩略图URL |
| tags | array<string> | 标签（如开启映射）|
| downloadCount | number | 下载次数 |
| viewCount | number | 浏览次数 |
| isFree | boolean | 是否免费 |
| price | number | 价格（分）|
| reportFileUrl | string | 报告文件URL |
| reportFileName | string | 报告文件名 |
| reportFileSize | string | 报告文件大小 |

请求示例（关键词查询）
```json
{
  "page": 1,
  "pageSize": 10,
  "keyword": "光伏"
}
```

请求示例（无关键词 → 默认近 30 天）
```json
{
  "page": 1,
  "pageSize": 10
}
```

请求示例（高级过滤 + 排序）
```json
{
  "page": 1,
  "pageSize": 20,
  "filters": {
    "category": ["综合", "新能源"],
    "source": ["盛世华研"]
  },
  "sortBy": "publishDate",
  "sortOrder": "desc"
}
```

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 156,
    "page": 1,
    "pageSize": 10,
    "list": [
      {
        "id": "report_001",
        "title": "2024-2025年光伏与储能逆变器市场现状调研及前景趋势预测报告",
        "summary": "本报告深入分析了光伏与储能逆变器市场的发展现状...",
        "source": "盛世华研",
        "category": "综合",
        "pages": 116,
        "fileSize": 2048,
        "publishDate": "2024-07-13",
        "updateDate": "2024-07-13",
        "thumbnail": "https://example.com/xxx.jpg",
        "tags": ["光伏", "储能"],
        "downloadCount": 1250,
        "viewCount": 5600,
        "isFree": false,
        "price": 9900
      }
    ]
  }
}
```

错误响应示例
```json
{
  "code": 400,
  "message": "参数错误",
  "data": null
}
```

---

#### 3.2 获取报告详情
- **方法与地址**: `GET /v1/reports/{id}`

入参（Path）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| id | string | 是 | 报告ID |

出参（Report）参见 3.1 Report 对象

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "report_001",
    "title": "2024-2025年光伏与储能...",
    "summary": "...",
    "source": "盛世华研",
    "category": "综合",
    "pages": 116,
    "fileSize": 2048,
    "publishDate": "2024-07-13",
    "updateDate": "2024-07-13",
    "thumbnail": "https://example.com/xxx.jpg",
    "tags": ["光伏", "储能"],
    "downloadCount": 1250,
    "viewCount": 5600,
    "isFree": false,
    "price": 9900
  }
}
```

---

#### 3.3 创建报告
- **方法与地址**: `POST /v1/reports/create`

入参（ReportCreateRequest，示例字段）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| title | string | 是 | 标题 |
| summary | string | 否 | 摘要 |
| source | string | 是 | 来源 |
| category | string | 是 | 分类 |
| pages | number | 否 | 页数 |
| fileSize | number | 否 | 文件大小（KB）|
| publishDate | string(YYYY-MM-DD) | 是 | 发布日期 |
| updateDate | string(YYYY-MM-DD) | 否 | 更新日期 |
| thumbnail | string | 否 | 缩略图URL |
| tags | array<string> | 否 | 标签 |
| isFree | boolean | 是 | 是否免费 |
| price | number | 否 | 价格（分；isFree=false 时必填）|
| reportFileUrl | string | 否 | 报告文件URL |
| reportFileName | string | 否 | 报告文件名 |
| reportFileSize | string | 否 | 报告文件大小 |

出参（Report）参见 3.1 Report 对象

请求示例
```json
{
  "title": "AI 在医疗的应用前景研究",
  "summary": "深入探讨AI技术在医疗诊断、药物研发...",
  "source": "麦肯锡",
  "category": "医疗健康",
  "pages": 156,
  "fileSize": 3072,
  "publishDate": "2024-07-05",
  "thumbnail": "https://example.com/r003.jpg",
  "tags": ["人工智能", "医疗健康"],
  "isFree": false,
  "price": 12900
}
```

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "report_999",
    "title": "AI 在医疗的应用前景研究",
    "publishDate": "2024-07-05",
    "isFree": false,
    "price": 12900
  }
}
```

---

#### 3.4 删除报告（单个）
- **方法与地址**: `DELETE /v1/reports/{id}`

入参（Path）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| id | string | 是 | 报告ID |

出参

| 字段 | 类型 | 说明 |
|---|---|---|
| data | number | 受影响行数（1 表示成功删除）|

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": 1
}
```

---

#### 3.5 批量删除报告
- **方法与地址**: `POST /v1/reports/delete`

入参（ReportBatchDeleteRequest）

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| ids | array<string> | 是 | 需要删除的报告ID集合 |

出参

| 字段 | 类型 | 说明 |
|---|---|---|
| data | number | 受影响行数（成功删除的数量）|

请求示例
```json
{
  "ids": ["report_001", "report_002", "report_003"]
}
```

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": 3
}
```

---

#### 3.6 健康检查
- **方法与地址**: `GET /v1/health`

成功响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": "服务运行正常"
}
```

---

#### 3.7 文件上传接口

##### 3.7.1 上传报告文件
- **方法与地址**: `POST /v1/upload/report`
- **Content-Type**: multipart/form-data
- **参数**: file (要上传的文件)
- **返回**: 文件URL、文件名、文件大小等信息

##### 3.7.2 上传图片文件
- **方法与地址**: `POST /v1/upload/image`
- **Content-Type**: multipart/form-data
- **参数**: file (要上传的图片文件)
- **返回**: 图片URL、文件名、文件大小等信息

##### 3.7.3 通用文件上传
- **方法与地址**: `POST /v1/upload/file`
- **Content-Type**: multipart/form-data
- **参数**: 
  - file (要上传的文件)
  - folder (存储文件夹，可选，默认为"files")
- **返回**: 文件URL、文件名、文件大小、文件夹等信息

##### 3.7.4 删除文件
- **方法与地址**: `DELETE /v1/upload/file`
- **参数**: url (要删除的文件URL)
- **返回**: 删除结果信息

---

### 四、状态码说明
| code | 说明 |
|---|---|
| 200 | 请求成功 |
| 400 | 参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

### 五、实现与架构要点
- **架构**: Controller → Service（无接口中间层）→ MyBatis Mapper → SQLite
- **业务类**: `com.yuesf.aireader.service.ReportService`
  - 负责"必须有条件"规则（无 keyword 时默认近 30 天），分页与排序兜底
  - 调用 `ReportMapper` 的 `selectReports/countReports/selectById`
- **Mapper 接口**: `com.yuesf.aireader.mapper.ReportMapper`
- **Mapper XML**: `resources/mappers/ReportMapper.xml`
  - 动态 SQL：关键词 LIKE（title/summary/tag）、默认近 30 天、支持多值 IN、LIMIT/OFFSET 分页与排序
- **数据库**: SQLite，包含 reports 和 report_tags 两个表，通过外键关联
- **文件存储**: 阿里云OSS，支持报告文件和图片文件的上传与管理

---

### 六、环境配置说明
| 项目 | 值 | 位置 |
|---|---|---|
| JDK | 17 | 根 `pom.xml` `<java.version>` |
| Spring Boot | 3.5.4 | 根 `pom.xml` Parent |
| MyBatis Spring Boot | 3.0.3 | `reader/pom.xml` |
| SQLite JDBC | 3.44.1.0 | `reader/pom.xml` |
| 端口 | 8080 | `application.yml` |
| 数据源 | `jdbc:sqlite:reader.db` | `application.yml` |
| MyBatis 映射 | `classpath*:mappers/*.xml` | `application.yml` |
| 类型别名 | `com.yuesf.aireader.entity` | `application.yml` |
| SQL 初始化 | `schema.sql` / `data.sql` | `application.yml` |

---

### 七、后端功能总结

#### 7.1 核心功能模块
1. **报告管理模块**
   - 报告的增删改查操作
   - 支持复杂条件查询和分页
   - 支持关键词搜索（标题、摘要、标签）
   - 支持多字段排序

2. **文件上传模块**
   - 支持报告文件上传到阿里云OSS
   - 支持图片文件上传到阿里云OSS
   - 支持通用文件上传功能
   - 支持文件删除功能
   - 文件类型和大小限制控制

3. **数据存储模块**
   - 使用SQLite作为主数据库
   - reports表存储报告基本信息
   - report_tags表存储报告标签信息
   - 通过外键关联保证数据一致性

#### 7.2 技术实现特点
1. **框架技术**
   - Spring Boot 3.5.4作为主框架
   - MyBatis作为ORM框架
   - SQLite作为嵌入式数据库
   - 阿里云OSS SDK进行文件存储操作

2. **安全控制**
   - 文件类型限制
   - 文件大小限制
   - 参数验证和异常处理

3. **性能优化**
   - 数据库索引优化
   - 分页查询避免大数据量传输
   - 合理的缓存策略

#### 7.3 部署与配置
1. **环境要求**
   - JDK 17
   - Maven 3.6+
   - 可访问的阿里云OSS服务

2. **配置项**
   - 数据库连接配置
   - OSS服务配置
   - 文件上传限制配置

---

### 八、阿里云OSS对接设计

#### 8.1 OSS配置设计
1. **配置参数**
   - `endpoint`: 阿里云OSS地域节点
   - `access-key-id`: 阿里云访问密钥ID
   - `access-key-secret`: 阿里云访问密钥Secret
   - `bucket-name`: OSS存储桶名称
   - `upload.max-file-size`: 文件最大大小限制
   - `upload.allowed-extensions`: 允许上传的文件扩展名列表
   - `upload.base-url`: OSS访问基础URL

2. **配置方式**
   - 通过`application.yml`进行配置
   - 使用`@ConfigurationProperties`注解自动绑定配置属性
   - 通过`OssConfig`类创建OSS客户端Bean

#### 8.2 OSS服务设计
1. **文件上传**
   - 支持多种文件类型上传（报告文件、图片、通用文件）
   - 自动生成唯一文件名，避免冲突
   - 文件按类型分类存储在不同文件夹中（reports/images/files）
   - 支持文件大小和类型验证

2. **文件删除**
   - 根据文件URL删除OSS中的文件
   - URL安全检查，防止误删其他文件

3. **文件命名策略**
   - 按文件类型分类存储：reports、images、files
   - 时间戳+UUID生成唯一文件名
   - 避免文件名冲突和安全问题

#### 8.3 OSS接口设计
1. **API接口**
   - `/v1/upload/report`: 上传报告文件
   - `/v1/upload/image`: 上传图片文件
   - `/v1/upload/file`: 通用文件上传
   - `/v1/upload/file`: 删除文件（DELETE方法）

2. **接口特点**
   - 统一使用`multipart/form-data`格式上传文件
   - 返回文件URL等信息供后续使用
   - 完善的异常处理和错误信息返回

#### 8.4 安全设计
1. **访问控制**
   - 通过配置文件管理AccessKey，避免硬编码
   - 文件类型和大小限制，防止恶意上传
   - URL验证，确保只删除本系统上传的文件

2. **配置安全**
   - 建议使用环境变量或配置中心管理敏感信息
   - 定期轮换AccessKey，提高安全性

---

### 九、注意事项
1. 查询接口必须具备条件：`keyword` 或显式 `startDate/endDate`；若都未提供，则默认按近 30 天范围查询。
2. `page` 从 1 开始；`pageSize` 最大 50，避免大结果集。
3. 日期格式统一 `YYYY-MM-DD`；价格单位为"分"。
4. 如需在列表返回 `tags`，可在 MyBatis XML 中追加关联查询与映射。
5. 文件上传相关字段：`reportFileUrl`、`reportFileName`、`reportFileSize` 用于存储文件相关信息。
6. 数据库使用外键约束，删除报告时会自动删除关联的标签数据。
7. 需要配置正确的阿里云OSS参数才能使用文件上传功能。